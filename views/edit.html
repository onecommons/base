{% extends 'layouts/layout-admin.html' %}

{% macro renderfields(schemapaths, prefix) %}

{% for schemafield in schemapaths %}
  {% set path = prefix + loop.key %}
  {% if loop.key == '_id' %}
  <input type=hidden name='{{ path }}' value='{{ df.getVal(path) }}' />
  {% elseif includeField(schemafield, path) %}
  <div class='row'>
  <div class="form-group{% if required == "required" %} required{% endif %}">
  	<label class="col-sm-3 control-label" for="{{ path }}">
      {% if isDbId(df.getVal(path)) %}
        <a href='/admin/edit/{{df.getVal(path)}}' target=_blank>{{ loop.key }}</a>
      {% else %}{{ loop.key }}{% endif %}
  </label>
  	<div class="col-sm-6">
    {% if readonlyField(schemafield, path) %}
       {{formatdata(df.getVal(path), obj)}}
    {% elseif schemafield.schema %}
       {% for val in df.getVal(path) %}
          <div class="well well-lg">
          {{ renderfields(getPaths(schemafield.schema), path+'[' + loop.index0 + '].') }}
          </div>
       {% endfor %}
    {% elseif schemafield.options.enum %}
       {{ df.select(path, schemafield.options.enum, {setBindType:true, forceValue:true}) }}
    {% elseif schemafield.caster %}
       {{ df.select(path, schemafield.caster.enumValues, {setBindType:true, forceValue:true}) }}
    {% else %}
       {{ df.input(path, { class:'form-control', type: getInputType(schemafield), defaultValue: getDefaultValue(schemafield), guessInputType: true}) }}
       {% if schemafield.options.ref === 'File' %}
       <button type="button" class="btn btn-two" data-toggle="modal" data-target="#upload-file">Upload File</button>
       {% endif %}
    {% endif %}
    </div>
  </div>
  </div>
  {% endif %}
{% endfor %}

{% endmacro %}

{% block head %}
<link rel="stylesheet" type="text/css" href="/selectize/css/selectize.css" />
<link rel="stylesheet" type="text/css" href="/selectize/css/selectize.bootstrap3.css" />
{% endblock %}

{% block admincontent %}
<!-- Modal -->
<div class="modal fade" tabindex="-1" id="upload-file" role="dialog" aria-labelledby="upload-file-title" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="upload-file-title">Upload File</h4>
      </div>
      <div class="modal-body">

        <form id="upload-file-form" role= "form">

        <div class='imagechooser'>
          <input class="form-control" type="file" name="upload" data-dbmethod='createfile' />
          <canvas style="width:100%" height="10px"></canvas>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="submit" id='payment-plan-update' class="btn btn-primary btn-two">Upload</button>
      </div>

      </form>

    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="">
{{df.form(obj, {class:"form-horizontal", role:"form"})}}
  {{renderfields(paths, '')}}

<button type="submit" id="submit-account-data" name="submit-account-data" class="btn btn-default btn-two mt-20">Submit</button>
{{df.form_end()}}
</div>
{% endblock %}

{% block jsfooter %}
<script type="text/javascript" src="/js/data.js"></script>
<script type="text/javascript" src="/selectize/js/standalone/selectize.js"></script>
<script>
// polyfill datetime-local
// webshim loads a bunch of stuff even on browsers that support datetime-local
// so do our own feature detection and dynamically load it

function polyfill() {
  //https://github.com/aFarkas/webshim v1.15.10
  //http://caniuse.com/#feat=input-datetime
  // load and implement all unsupported features
  webshim.setOptions("forms-ext", {
    replaceUI: "auto",
    types: "datetime-local",
  });
  webshims.polyfill('forms-ext');
}

var test = document.createElement('input');
test.type = 'datetime-local';
test.value = 'Hello World';
if (test.value === 'Hello World') {
  // input type not supported
  var oScript = document.createElement("script");
  oScript.type = "text/javascript";
  oScript.onload = polyfill;
  document.head.appendChild(oScript);
  oScript.src = "/js-webshim/minified/polyfiller.js";
}
</script>
<script type="text/javascript">
function createCallback(result, err) {
  if (result && result._id && !err) {
    window.location = '/admin/edit/' + result._id  + '?msg=Created!';
  }
}

$(document).ready(function () {
  {{df.formhandler(dbmethod, dbcallback)}}

  $(document).on('submit', '#upload-file-form', function() {
      var ref = $(this).data('ref');
      $(this).dbExecute('/adminMethods#', function(resp, err) {
        if (!err) {
          $('#upload-file').modal('hide');
          $(ref).val(resp._id);
        }
      });
      return false;
  });
  $(document).on('change', '.imagechooser', function(e) {
      handleImage(e, $(this).find('canvas').get(0))
  });
  $('#upload-file').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget) // Button that triggered the modal
    var recipient = button.prev('input').get(0).name;
    $(this).find('form').data('ref', 'input[name=\'' + recipient + '\']')
  });

  $('.dbform select').selectize({
  plugins: ['remove_button'],
  create: false,
 });

 var msg = '{{query.msg}}';
 if (msg) {
   setAlert('alert-success', msg);
 }
});
$(document).bind("ajaxSend", function(evt, jqXhr, ajaxSettings){
    jqXhr.setRequestHeader('x-csrf-token', '{{_csrf}}');
 });
 function handleImage(e, canvas) {
    var reader = new FileReader();
    var ctx = canvas.getContext('2d');
    reader.onload = function(event){
        var img = new Image();
        img.onload = function(){
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
        }
        img.src = event.target.result;
    }
    var file = e.target.files[0];
    var size = file.size; //XXX error if it's too big
    reader.readAsDataURL(file);
}
</script>
{% endblock %}
